{"version":3,"file":"static/webpack/static\\development\\pages\\index.js.de72b7c2173c9c54331a.hot-update.js","sources":["webpack:///./hooks/identity.js"],"sourcesContent":["import { createContext, useContext, useState, useEffect } from \"react\";\r\nimport Axios from \"axios\";\r\nimport {apiUrl} from \"../constants/index\"\r\n\r\nimport dynamic from 'next/dynamic';\r\nimport { AccountModal } from \"../components/AccountPicker\";\r\n\r\nconst Identity = createContext([{active: null, users:[]}, undefined]);\r\n\r\n\r\nvar initActive = null;\r\n\r\nexport class IdentityProvider extends React.Component{\r\n    constructor(props) {\r\n        super(props);\r\n\r\n        this.initial = !props.disablePopup;\r\n        this.state= {\r\n            id: {active: null, users: []},\r\n            axios: undefined,\r\n\r\n        };\r\n\r\n        this.modalRef = React.createRef();\r\n\r\n        this.beforeMount();\r\n    }\r\n\r\n    request = (req) => {\r\n        const ide = this.state.id;\r\n        if(Number.isInteger(ide.active) && ide.users && ide.users[ide.active]) {\r\n            console.log(\"token supplied\");\r\n            req.headers.Authorization = `Bearer ${ide.users[ide.active].accessToken}`;\r\n            return req;\r\n        }\r\n        throw \"Request not authorized\";\r\n    }\r\n\r\n    response = (res) => {\r\n        if(res.status === 401) {\r\n            var no = res.headers[\"Www-Authenticate\"].split(\",\");\r\n            ///...\r\n\r\n            ///removeUser(id.users[id.active].idString);\r\n        } \r\n        return res;\r\n    }\r\n\r\n    reject = (error) => {\r\n        // Do something with request error\r\n        return Promise.reject(error);\r\n    }\r\n\r\n    toggleModal = () => {\r\n        if(!this.props.disablePopups)\r\n            this.modalRef.current.toggleModal();\r\n    }\r\n\r\n    addUser = (idString, username, accessToken) => {\r\n        let newUsrIndex = {e: -1};\r\n\r\n        this.setState ((prev) => {\r\n            var newO = {...prev.id};\r\n\r\n            var index = newO.users.findIndex((val) => val.username === username);\r\n            if(index===-1){\r\n                newO.users = [...newO.users, {idString, username, accessToken}];\r\n                newUsrIndex ={e: newO.users.length};\r\n            }else {\r\n                var e = [...newO.users];\r\n                e[index].accessToken = accessToken;\r\n                delete e[index].error;\r\n                newO.users = e;\r\n                newUsrIndex = {e: index};\r\n            }\r\n            \r\n            return {id: newO};\r\n        }, () => {\r\n            this.setActive(newUsrIndex.e);\r\n        });\r\n    }\r\n\r\n    removeUser= (username) => {\r\n        this.setState((prev) => {\r\n            var newO = {...prev.id};\r\n\r\n            var index = newO.users.findIndex((val) => val.username === username);\r\n\r\n            if(index>-1)\r\n                newO.users.splice(index, 1);\r\n            \r\n            return {id: newO};\r\n        });\r\n    }\r\n\r\n    setActive = async (idx) => {\r\n        console.log(\"SETACTIVE \"+idx)\r\n        if(await this.check(idx) === \"yes\") {\r\n            this.setState((prev) => {\r\n                var newO = {...prev.id};\r\n    \r\n                if(idx > -1 && idx < prev.id.users.length || idx === null) {\r\n                    newO.active = idx;    \r\n                } \r\n                return {id: newO};\r\n            });\r\n        }\r\n    }\r\n\r\n    persist() {\r\n        console.log(\"persist\");\r\n        localStorage.setItem(\"active\", JSON.stringify(this.state.id.active));\r\n        localStorage.setItem(\"users\", JSON.stringify(this.state.id.users));\r\n    }\r\n\r\n    check(idx) {\r\n        if(idx >= this.state.id.users.length) return ;\r\n        if(idx === null || this.state.id.users[idx].test === true) {\r\n            return \"yes\";\r\n        }\r\n\r\n        return Axios.get(\"/user/me\", {headers: {Authorization: `Bearer ${this.state.id.users[idx].accessToken}`}, baseURL: apiUrl})\r\n        .then((val) => {\r\n            console.log(\"✔ Account ok: \",val);\r\n            \r\n            this.setState((prev)=> {\r\n                var newO = {...prev.id};\r\n                var e = [...newO.users];\r\n                e[idx].username = val.data.username;\r\n                e[idx].moderator = val.data.moderator;\r\n                e[idx].avatarUrl = val.data.avatarUrl;\r\n                delete e[idx].error;\r\n                newO.users = e;\r\n                return {id: newO};\r\n            })\r\n            return \"yes\";\r\n        }, (reason)=>{\r\n            console.log(\"❌ Account bad: \", reason);\r\n\r\n            if(reason.response && reason.response.headers[\"www-authenticate\"]) {\r\n                //authenticate header\r\n                var auth = reason.response.headers[\"www-authenticate\"];\r\n                console.log(auth);\r\n                var tokens = auth.split(\",\").map(x => x.trim());\r\n\r\n                var error= {};\r\n\r\n                //parse header\r\n                if(tokens[1] && tokens[1].startsWith('error=\"')) {\r\n                    error.err = tokens[1].substring(7, tokens[1].length-1);\r\n                }\r\n                if(tokens[2] && tokens[2].startsWith('error_description=\"')) {\r\n                    error.desc = tokens[2].substring(19, tokens[2].length-1);    \r\n                }\r\n\r\n                //decide what to do\r\n                switch(error.err) {\r\n                    case \"UnsupportedAuthError\":\r\n                        throw reason;\r\n                    \r\n                    case \"TokenClaimError\":\r\n                        if(error.desc === \"insufficient claims.\") {\r\n                            error.icon = \"bolt\"\r\n                        } else if(error.desc === \"invalid claims.\") {\r\n                            error.icon = \"death\"\r\n                        }\r\n                        break;\r\n\r\n                    case \"TokenExpiredError\":\r\n                        error.icon = \"time\";\r\n                        break;\r\n\r\n                    case \"NotBeforeError\":\r\n                        error.icon = \"time\";\r\n                        break;\r\n\r\n                    case \"JsonWebTokenError\":\r\n                        error.icon = \"bolt\";\r\n                        break;\r\n                }\r\n\r\n                console.log(error);\r\n                if( error.icon ) {\r\n                    return this.setState((prev) => {\r\n                        var newUsers = [...prev.id.users];\r\n                        \r\n                        newUsers[idx] = {...newUsers[idx], error: error};\r\n\r\n                        return {id:{...prev.id, users: newUsers, active: null}};\r\n                    });\r\n                }\r\n            } \r\n\r\n            //tf happened\r\n            this.setState((prev) => {return {id:{...prev.id, active: null}}});\r\n            return \"no\";\r\n        })\r\n    \r\n    }\r\n\r\n    beforeMount() {\r\n        if(typeof window === 'undefined') {\r\n            return;\r\n        }\r\n        console.log(\"before\");\r\n\r\n        //get initial data\r\n        var active,users;\r\n\r\n        try {\r\n            active = JSON.parse(localStorage.getItem(\"active\") || \"null\");  \r\n        } catch (error) {\r\n            active= this.state.id.active;\r\n        }\r\n        try {\r\n            users = JSON.parse(localStorage.getItem(\"users\") || \"[]\");\r\n        } catch (error) {\r\n            users= this.state.id.users;\r\n        }\r\n        \r\n\r\n        const instance = Axios.create({\r\n            baseURL: apiUrl\r\n        });\r\n\r\n        instance.interceptors.request.use(this.request, this.reject);\r\n        instance.interceptors.response.use(this.response, this.reject);\r\n\r\n        //pass context down\r\n\r\n        this.state.id= {active: null, users, addUser: this.addUser, removeUser: this.removeUser, setActive: this.setActive, toggleModal: this.toggleModal};\r\n        this.state.axios = instance;\r\n\r\n        initActive = active;\r\n\r\n        //this.setState(prev=> {return {id: {active, users, addUser: this.addUser, removeUser: this.removeUser, setActive: this.setActive}, axios: instance}});\r\n    }\r\n\r\n    componentDidMount() {\r\n        publish();\r\n        this.setActive(initActive).then(() => {\r\n            if(this.state.id.active == null && this.initial) {\r\n                this.toggleModal();\r\n            }\r\n        });\r\n        \r\n    }\r\n\r\n\r\n    render() {\r\n        if(typeof window !== 'undefined') {\r\n            this.persist();\r\n        }\r\n        return <Identity.Provider value={[this.state.id, this.state.axios]}>\r\n            <AccountModal user ={undefined} ref={this.modalRef} id={this.state.id}/>\r\n            {this.props.children}\r\n        </Identity.Provider>;\r\n    }\r\n        \r\n}\r\n    \r\n\r\nexport const useIdentity = () => {\r\n    return useContext(Identity);\r\n}\r\n\r\nfunction publish() {\r\n    console.log(\"GLOBAL\");\r\n    window.supersecrettestusers = () => {\r\n        localStorage.setItem(\"users\", \r\n            `[\r\n                {\r\n                    \"username\":\"test-_-\",\r\n                    \"idString\":\"gamer\",\r\n                    \"accessToken\":\"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyaWQiOiI2MGMzYjRlMC04YjI5LTExZWEtODI5MS0xM2JmNDBkZmVmYWQiLCJpYXQiOjE1OTEzOTI0MTksImV4cCI6MTU5MTk5NzIxOSwiYXVkIjoiVXNlciIsImlzcyI6IkRSS1NMViJ9.dcnyAkv1Z3qzPdBpo_0s4-YP642amNVOGFCwMItvsoo\",\r\n                    \"error\": {\r\n                        \"err\":\"TokenClaimError\",\r\n                        \"desc\":\"invalid claims.\",\r\n                        \"icon\":\"death\"\r\n                    },\r\n                    \"test\":\"true\"\r\n                },\r\n                {\r\n                    \"username\":\"gamer\",\r\n                    \"idString\":\"gamer\",\r\n                    \"accessToken\":\"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyaWQiOiI0ZWU3NjkxMC04YjI5LTExZWEtODI5MS0xM2JmNDBkZmVmYWQiLCJpYXQiOjE1OTE0NjA4ODcsImV4cCI6MTU5MjA2NTY4NywiYXVkIjoiVXNlciIsImlzcyI6IkRSS1NMViJ9.S2UrWzhT8jj8ewDP4ZIqrzlOx6yKQN-8fCZVugW2W6k\",\r\n                    \"error\":{\r\n                        \"err\":\"JsonWebTokenError\",\r\n                        \"desc\":\"invalid signature\",\r\n                        \"icon\":\"bolt\"\r\n                    },\r\n                    \"test\":\"true\"\r\n                },\r\n                {\r\n                    \"username\":\"felix-d-class\",\r\n                    \"idString\":\"gamer\",\"accessToken\":\"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyaWQiOiIxMDMwMzA2MC1hODEzLTExZWEtOTNiZS0yNzBhMjBjM2EyOTQiLCJpYXQiOjE1OTE0NjEwNTYsImV4cCI6MTU5MjA2NTg1NiwiYXVkIjoiVXNlciIsImlzcyI6IkRSS1NMViJ9.zb78T8307vb-mBncJ7AwmShV2cxMX2nfchaUYZXD6fE\",\r\n                    \"error\":{\r\n                        \"err\":\"JsonWebTokenError\",\r\n                        \"desc\":\"invalid signature\",\r\n                        \"icon\":\"bolt\"\r\n                    },\r\n                    \"test\":\"true\"\r\n                }\r\n            ]`\r\n        );\r\n        window.location.reload(false);    \r\n    }\r\n\r\n    window.supersecrettrashusers = () => {\r\n        localStorage.setItem(\"users\", `[\r\n            {\r\n                \"username\": \"sonic\",\r\n                \"idString\": \"bruh\",\r\n                \"accessToken\": \"hurensohn\",\r\n                \"error\": {\r\n                    \"err\":\"NotBeforeError\",\r\n                    \"desc\":\"e\",\r\n                    \"icon\":\"time\"\r\n                },\r\n                \"test\":\"true\"\r\n            },\r\n            {\r\n                \"username\": \"turtle\",\r\n                \"idString\": \"bruh\",\r\n                \"accessToken\": \"hurensohn\",\r\n                \"error\": {\r\n                    \"err\":\"TokenExpiredError\",\r\n                    \"desc\":\"e\",\r\n                    \"icon\":\"time\"\r\n                },\r\n                \"test\":\"true\"\r\n            },\r\n            {\r\n                \"username\": \"d-class-personell\",\r\n                \"idString\": \"bruh\",\r\n                \"accessToken\": \"hurensohn\",\r\n                \"error\": {\r\n                    \"err\":\"TokenClaimError\",\r\n                    \"desc\":\"invalid claims.\",\r\n                    \"icon\":\"death\"\r\n                },\r\n                \"test\":\"true\"\r\n            },\r\n            {\r\n                \"username\": \"Jorji-Costava\",\r\n                \"idString\": \"bruh\",\r\n                \"accessToken\": \"hurensohn\",\r\n                \"error\": {\r\n                    \"err\":\"JsonWebTokenError\",\r\n                    \"desc\":\"invalid signiture\",\r\n                    \"icon\":\"bolt\"\r\n                },\r\n                \"test\":\"true\"\r\n            }\r\n        ]\r\n        `);\r\n        window.location.reload(false);    \r\n    } \r\n}\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AAEA;AACA;AAEA;AAAA;AAAA;AAAA;AAGA;AAEA;AAAA;AACA;AADA;AACA;AAAA;AAAA;AACA;AADA;AACA;AAAA;AACA;AAFA;AAgBA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AAxBA;AA0BA;AACA;AAGA;AACA;AACA;AAAA;AACA;AACA;AAlCA;AAoCA;AACA;AACA;AACA;AAvCA;AAyCA;AAEA;AACA;AA5CA;AA8CA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AApEA;AAsEA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AAGA;AAAA;AAAA;AACA;AACA;AACA;AAjFA;AAkFA;AAAA;AAAA;AAAA;AACA;AADA;AAAA;AACA;AADA;AAAA;AACA;AADA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAXA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAhFA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAFA;AAMA;AACA;AACA;AACA;AAbA;AAaA;AACA;AAfA;AAAA;AAAA;AAkGA;AACA;AACA;AACA;AArGA;AAAA;AAAA;AAuGA;AACA;AAAA;AACA;AAAA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AAAA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAtBA;AACA;AAwBA;AACA;AAAA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AACA;AAEA;AA1LA;AAAA;AAAA;AA6LA,mBAEA;AACA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AADA;AAIA;AACA;AACA;AAGA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AAGA;AAhOA;AAAA;AAAA;AAkOA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AAEA;AA1OA;AAAA;AAAA;AA8OA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AArPA;AACA;AADA;AAAA;AA0PA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AAoCA;AACA;AACA;AACA;AACA;AA+CA;AACA;AACA;;;;A","sourceRoot":""}